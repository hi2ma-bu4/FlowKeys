{
  "version": 3,
  "sources": ["../src/FlowKeys.ts"],
  "sourcesContent": ["type Key = KeyboardEvent[\"key\"];\ntype CommandCallback = () => void;\ntype KeyCombo = Set<Key>;\n\ninterface TrieNode {\n\tchildren: Map<string, TrieNode>;\n\tcallback?: CommandCallback;\n}\n\nexport class FlowKeys {\n\tprivate root: TrieNode = { children: new Map() };\n\tprivate buffer: KeyCombo[] = [];\n\tprivate maxSequenceLength = 0;\n\tprivate pressedKeys: Set<Key> = new Set();\n\tprivate aliasMap: Map<Key, Key[]> = new Map();\n\tprivate target: HTMLElement | Document | Window;\n\tprivate keyPushTimeout = 30;\n\tprivate keyPushTimer: number | null = null;\n\n\t// 標準化マップ（OS/ブラウザ差異の吸収）\n\tprivate static STANDARD_KEY_MAP: Record<Key, Key> = {\n\t\tEsc: \"Escape\",\n\t\tDel: \"Delete\",\n\t\tReturn: \"Enter\",\n\t\tLeft: \"ArrowLeft\",\n\t\tRight: \"ArrowRight\",\n\t\tUp: \"ArrowUp\",\n\t\tDown: \"ArrowDown\",\n\t\t\" \": \"Space\",\n\t\tCtrl: \"Control\",\n\t\tCmd: \"Meta\",\n\t\tWindows: \"Meta\",\n\t};\n\n\tconstructor(target?: HTMLElement | Document | Window) {\n\t\tthis.target = (target ?? window) as Window;\n\t\tthis.handleKeyDown = this.handleKeyDown.bind(this);\n\t\tthis.handleKeyUp = this.handleKeyUp.bind(this);\n\t\tthis.target.addEventListener(\"keydown\", this.handleKeyDown, true);\n\t\tthis.target.addEventListener(\"keyup\", this.handleKeyUp, true);\n\t}\n\n\t// 代替キー登録\n\tpublic addAlias(key: Key, aliases: Key[]) {\n\t\tthis.aliasMap.set(\n\t\t\tkey.toLowerCase(),\n\t\t\taliases.map((k) => k.toLowerCase())\n\t\t);\n\t}\n\n\t// シーケンス登録\n\tpublic register(sequence: (Key | Key[])[], callback: CommandCallback) {\n\t\tif (!sequence.length) return;\n\t\tthis.maxSequenceLength = Math.max(this.maxSequenceLength, sequence.length);\n\n\t\tlet node = this.root;\n\t\tfor (const item of sequence) {\n\t\t\tconst combo = new Set(Array.isArray(item) ? item : [item]);\n\t\t\tconst key = FlowKeys.setToKey(this.normalizeCombo(combo));\n\t\t\tif (!node.children.has(key)) node.children.set(key, { children: new Map() });\n\t\t\tnode = node.children.get(key)!;\n\t\t}\n\t\tnode.callback = callback;\n\t}\n\n\tprivate normalizeCombo(combo: KeyCombo): KeyCombo {\n\t\tconst normalized = new Set<Key>();\n\t\tfor (let k of combo) {\n\t\t\t// 標準化キーに変換\n\t\t\tk = (FlowKeys.STANDARD_KEY_MAP[k] ?? k).toLowerCase();\n\n\t\t\tlet mapped = false;\n\t\t\tfor (const [key, aliases] of this.aliasMap) {\n\t\t\t\tif (aliases.includes(k)) {\n\t\t\t\t\tnormalized.add(key);\n\t\t\t\t\tmapped = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!mapped) normalized.add(k);\n\t\t}\n\t\treturn normalized;\n\t}\n\n\tprivate static setToKey(combo: KeyCombo) {\n\t\treturn Array.from(combo).sort().join(\"+\");\n\t}\n\n\tprivate handleKeyDown(event: KeyboardEvent) {\n\t\tconst key = (FlowKeys.STANDARD_KEY_MAP[event.key] ?? event.key).toLowerCase();\n\t\tconst now = performance.now();\n\n\t\tthis.pressedKeys.add(key);\n\n\t\tif (this.keyPushTimer !== null) clearTimeout(this.keyPushTimer);\n\t\tthis.keyPushTimer = window.setTimeout(() => {\n\t\t\tthis.updateBuffer();\n\t\t\tthis.keyPushTimer = null;\n\t\t}, this.keyPushTimeout);\n\t}\n\n\tprivate handleKeyUp(event: KeyboardEvent) {\n\t\tconst key = (FlowKeys.STANDARD_KEY_MAP[event.key] ?? event.key).toLowerCase();\n\t\tthis.pressedKeys.delete(key);\n\t}\n\n\tprivate updateBuffer() {\n\t\tconst comboKey = this.normalizeCombo(this.pressedKeys);\n\t\tthis.buffer.push(comboKey);\n\t\tif (this.buffer.length > this.maxSequenceLength) this.buffer.shift();\n\t\tthis.checkBuffer();\n\t}\n\n\tprivate checkBuffer() {\n\t\tif (!this.buffer.length) return;\n\t\tconsole.log(this.buffer);\n\t\tlet node = this.root;\n\t\t// 最新入力から先頭まで順にたどる\n\t\tfor (let i = this.buffer.length - this.maxSequenceLength; i < this.buffer.length; i++) {\n\t\t\tif (i < 0) continue;\n\t\t\tnode = this.root;\n\t\t\tlet match = true;\n\t\t\tfor (let j = i; j < this.buffer.length; j++) {\n\t\t\t\tconst keyStr = FlowKeys.setToKey(this.buffer[j]);\n\t\t\t\tif (!node.children.has(keyStr)) {\n\t\t\t\t\tmatch = false;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tnode = node.children.get(keyStr)!;\n\t\t\t}\n\t\t\tif (match && node.callback) {\n\t\t\t\tnode.callback();\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic destroy() {\n\t\t(this.target as Window).removeEventListener(\"keydown\", this.handleKeyDown, true);\n\t\t(this.target as Window).removeEventListener(\"keyup\", this.handleKeyUp, true);\n\t\tif (this.keyPushTimer !== null) clearTimeout(this.keyPushTimer);\n\t\tthis.buffer = [];\n\t\tthis.root = { children: new Map() };\n\t\tthis.pressedKeys.clear();\n\t\tthis.aliasMap.clear();\n\t\tthis.maxSequenceLength = 0;\n\t}\n}\n\nif (typeof window !== \"undefined\") {\n\t(window as any).FlowKeys = FlowKeys;\n}\n"],
  "mappings": "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",
  "names": []
}
